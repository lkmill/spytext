!function(){var t=MOD.assign,e=Element.prototype;t(e,"tidy",function(t){function e(i,s,a,o){if(i&&(!a&&i.firstChild&&(s||i.tagName!==t||(i.emptyNested(),s=!0),e(i.firstChild,s,!1,null)),i!==n)){var r=i.nextSibling;if(!a&&r&&e(r,!1,!1,null),r&&1===r.nodeType&&1===i.nodeType&&r.isInline()&&(o||i.isInline())){var l=r.getTag(t);if(!l)return e(r,s,!0);if(!o&&(o=i.getTag(t),!o))return e(r,s,!0,l);if(o===i){if(l===r){for(;r.firstChild;)i.append(r.firstChild);r.vanish()}else i.append(r),l.unwrap();return e(i,s,!0,o)}if(l===r)return r.prepend(i),o.unwrap(),e(r,s,!0,r);var h=O("<"+t+"></"+t+">");return i.before(h),h.append(i),h.append(r),o.unwrap(),l.unwrap(),e(h,s,!0,h)}e(r,s,!0,null)}}var n=this;return t=t||this.tagName,e(this,!1,!1,null),this.normalize(),e(this,!1,!1,null),this.normalize(),this.setBR(),this}),t(e,"setBR",function(){if(this.firstChild&&this.firstChild===this.lastChild&&3===this.firstChild.nodeType&&0===this.firstChild.textContent.length&&this.removeChild(this.firstChild),this.firstChild)for(var t=this.getElementsByTagName("BR"),e=t.length,n=0;e>n;n++)t[n].previousSibling&&(t[n].vanish(),n--,e--);else this.appendChild(O("<BR>"))}),t(e,"unwrap",function(){for(var t=[];this.lastChild;)t.push(this.lastChild),this.after(this.lastChild);return this.vanish(),M(t)}),t(e,"emptyNested",function(t){t=t||this.tagName;var e=M(this.getElementsByTagName(t));e.each(function(){this.unwrap()})}),t(e,"isTag",function(t){return this.tagName===t}),t(e,"getTag",function(t){t=t||this.tagName;if(this.tagName===t)return this;for(var e=this;e.firstChild&&e.firstChild===e.lastChild;){if(e.tagName===t)return e;e=e.firstChild}return null}),e=Node.prototype,t(e,"ancestors",function(t,e){for(var n=[],i=this.closest(t,e);i;)n.push(i),i=i.closest(t,e);return M(n)}),t(e,"isBlock",function(){return this&&1===this.nodeType&&!getComputedStyle(this).display.match(/inline/)}),t(e,"isInline",function(){return this&&(3===this.nodeType||!getComputedStyle(this).display.match(/inline/))})}();var Spytext=function(){var t=function(t,e){var n=this;this.fields=[],this.field=null,this.element=null,this.snapback=null,this.selectron=null,this.buttons={},this.dropdowns={},this.toolbar=null,_.each(this.events.doc,function(t,e){document.bind(e,t,n)}),t&&(this.toolbar=new i({preset:"standard"},this),e&&e.angular||(t.prepend(this.toolbar.element),t.M("[spytext-field], .spytext-field").each(function(){n.addField(this,{preset:"full"})})))};t.prototype={setCurrentField:function(t){this.fields.indexOf(t)>-1?(this.field=t,this.element=t.element,this.snapback=t.snapback,this.selectron=t.selectron,this.toolbar.enable()):this.unsetCurrentField()},unsetCurrentField:function(){this.field=this.element=this.snapback=this.selectron=null,this.toolbar.disable()},events:{doc:{mouseup:function(){var t=this;this.field&&(this.snapback.register(),setTimeout(function(){t.toolbar.setActiveStyles()},100))}}},actions:{align:function(t){var e=this.selectron.contained(1,1);e.each(function(){this.matches("ul, ol")||this.css("text-align",t.alignment)})},block:function(t){function e(t,e){e=e||t;var n=s.clone();for(e.before(n);t.firstChild;)n.append(t.firstChild);t.vanish(),n.setBR(),a.push(n)}var n=this,i=this.selectron.get(!0),s=O("<"+t.tag+"></"+t.tag+">"),a=[];this.selectron.contained(1,1).each(function(){var t=this;if("UL"===this.nodeName||"OL"===this.nodeName){var i=this.offspring("li"),s=n.selectron.contained(i),o=i.indexOf(s[0]);if(s.each(function(){e(this,t)}),this.firstChild){if(o>0){for(var r=O("<"+this.tagName+"><"+this.tagName+"/>");o<this.childNodes.length;)this.after(r),r.prepend(this.lastChild);this.after(M(a))}}else this.vanish()}else e(this)}),i.restore()},deleteRangeContents:function(t){function e(t,n){n=n||t;for(var i,s=t;!i&&s&&s!==o;)s.nextSibling?i=s.nextSibling:s=s.parentNode;t&&n!==t&&t.vanish(),i&&e(i,n)}var n=t.commonAncestorContainer;if(n===this.element||1===n.nodeType&&n.matches("UL, OL")){var i,s=this.selectron.get(),a=t.startContainer.ancestors(null,this.element).toArray(),o=a.length>0?_.last(a):this.element.firstChild,r=this.selectron.contained(1,1,!0);if(this.selectron.contained(M(o),null,!0).length>0)o.empty();else{for("LI"===o.firstChild.tagName&&(this.selectron.contained(o.childNodes,null,!0).vanish(),o=t.startContainer.closest("LI",h)),node=t.startContainer;node&&3!==node.nodeType;)node=node.firstChild;node&&(node.splitText(t.startOffset),i=node,e(node))}var l=t.endContainer.ancestors(null,this.element).toArray(),h=_.last(l);if(h&&this.selectron.contained(M(h),null,!0).length<1){var d;"LI"===h.firstChild.tagName?(d=t.endContainer.closest("LI",h),this.selectron.contained(h.childNodes,null,!0).vanish()):d=h;var c=s.clone();for(c.start={ref:d,offset:0,isAtStart:!0},c.restore(),this.selectron.range().deleteContents();d.firstChild;)o.appendChild(d.firstChild);d.vanish()}if(!o.firstChild||0===o.firstChild.textContent.length||o.firstChild.textContent.match(/^\s+$/)){if(o.firstChild&&(0===o.firstChild.textContent.length||o.firstChild.textContent.match(/^\s+$/))&&o.firstChild.vanish(),o.matches("UL, OL")){var p=O("<p>");o.before(p),o.vanish(),o=p}o.setBR(),s.start={ref:o,offset:0,isAtStart:!0}}M(r).vanish(),s.end=s.start,s.restore()}else t.deleteContents()},join:function(t,e){var n=this.selectron.get(!0),i=e.parentNode;if(t.matches("LI")&&e.matches("LI")&&t.closest("UL,OL")!==e.closest("UL, OL"))t.after(M(i.children)),i.vanish();else for("BR"===t.lastChild.tagName&&t.removeChild(t.lastChild),1===e.nodeType&&e.matches("UL, OL")&&(e=e.firstChild);e.firstChild;)t.appendChild(e.firstChild);t.setBR(),e.firstChild&&0!==e.textContent.length?e.setBR():e.vanish(),i.firstChild||i.vanish(),t.setBR(),n.restore()},newline:function(){var t,e=this.selectron.range(),n=1===e.startContainer.nodeType&&e.startContainer.matches("LI, P, H1, H3, H4, H5, H6")?e.startContainer:e.startContainer.closest("LI, P, H1, H2, H3, H4, H5, H6",this.element),i=this.selectron.get(n,!0);if(n.matches("LI")&&0===n.textContent.length)this.actions.block.call(this,{tag:"P"});else{var s=O("<"+n.tagName+">");for(n.after(s),i.end.offset!==i.end.ref.textContent.length&&(i.end={ref:n,offset:n.textContent.length},i.restore(),t=this.selectron.range().extractContents());t&&t.firstChild;)s.appendChild(t.firstChild);s.setBR(),n.setBR(),this.selectron.set(s,0)}},list:function(t){var e=this,n=O("<"+t.tag+"></"+t.tag+">"),i=this.selectron.get(null,!0),s=this.selectron.contained(1,1);(1!==s.length||s[0].tagName!==t.tag)&&(s[0].before(n),s.each(function(){if("UL"===this.nodeName||"OL"===this.nodeName){var t=this.offspring("li"),i=e.selectron.contained(t),s=t.indexOf(i[0]);if(i.each(function(){n.append(this)}),this.firstChild){if(s>0){for(var a=O("<"+this.tagName+"><"+this.tagName+"/>");s<this.childNodes.length;)this.after(a),a.prepend(this.lastChild);this.after(n)}}else this.vanish()}else{var o=O("<li></li>");for(n.append(o);this.firstChild;)o.append(this.firstChild);n.append(o),this.vanish()}}),i.restore())},indent:function(){for(var t=this.selectron.contained("li"),e=this.selectron.get(null,!0),n=0;n<t.length;n++){var i=t[n].closest("ul, ol",this.element).tagName,s=t[n].previousSibling;if(s){var a=s.offspring(i)[0],o=a||O("<"+i+"></"+i+">");o!==a&&s.append(o),o.append(t[n])}}e.restore()},format:function(t){var e=this.selectron.get(null,!0);console.log(e);var n=this.selectron.contained(3).toArray();console.log(n);var i=this.selectron.range();if(i.endOffset<i.endContainer.textContent.length){for(node=i.endContainer;node.firstChild&&3!==node.nodeType;)node=node.firstChild;node&&node.splitText(i.endOffset)}if(i.startOffset>0){for(node=i.startContainer;node&&3!==node.nodeType;)node=node.firstChild;node&&n.splice(0,1,node.splitText(i.startOffset))}M(n).wrap(t.container?O(t.container).clone():O("<"+t.tag+"></"+t.tag+">")),this.selectron.contained(1,1).tidy(t.container?t.container.tagName:t.tag),e.restore()},link:function(){var t=window.getSelection(),e=t.focusNode.parentNode;"a"!==e.tagName.toLowerCase()&&(e=t.anchorNode.parentNode,"a"!==e.tagName.toLowerCase()&&(e=null));var n="http://";if(e){var i=document.createRange();i.selectNodeContents(e),n=e.attributeibutes.href.value,t.removeAllRanges(),t.addRange(i)}var s=prompt("Link address:",n);""!==s?document.execCommand("createLink",null,s):document.execCommand("unlink")},paste:function(t){var e=this.selectron.range(),n=t.getData("Text");n=n.replace(/</g,"&lt;").replace(/>/,"&gt;").replace(/[\n\r]+$/g,"");var i,s=n.split(/[\n\r]+/),a=1===e.startContainer.nodeType&&e.startContainer.matches("LI, H1, H2, H3, H4, H5, H6, P")?e.startContainer:e.startContainer.closest("LI, H1, H2, H3, H4, H5, H6, P"),o=this.selectron.get(a);if(0!==s.length){if(1===s.length){if(i=document.createTextNode(s[0]),0===e.startOffset)1===e.startContainer.nodeType?("BR"===e.startContainer.lastChild.nodeName&&e.startContainer.lastChild.vanish(),e.startContainer.prepend(i)):e.startContainer.parentNode.prepend(i);else if(e.startOffset===e.startContainer.textContent.length)1===e.startContainer.nodeType?e.startContainer.append(i):e.startContainer.parentNode.append(i);else{var r=e.startContainer;r.splitText(e.endOffset),r.after(i)}o.start.offset=o.start.offset+i.textContent.length,o.end=o.start}else{o.end={ref:a,offset:a.textContent.length},o.restore();for(var l=this.selectron.range().extractContents(),h=s.length-1;h>=0;h--)if(i=document.createTextNode(s[h]),0===h)"BR"===a.lastChild.nodeName&&a.lastChild.vanish(),a.append(i);else{var d=O("<"+a.tagName+">");if(d.append(i),h===s.length-1){for(;l.firstChild;)d.append(l.firstChild);o.start={ref:d,offset:i.textContent.length,isAtStart:!1},o.end=o.start}a.after(d)}}o.restore()}},removeFormat:function(){document.execCommand("removeFormat")}},addField:function(t,e){var n=new s(this,t,e);return this.fields.push(n),n},execute:function(t,e){var n=this;this.selectron.normalize(),this.snapback.register(),this.actions[t]&&(this.actions[t].call(this,e),this.toolbar.setActiveStyles(),setTimeout(function(){n.snapback.register()},100))}};var e=function(t,e){var n=this;this.spytext=e,this.config="string"==typeof t.preset?_.merge(this.presets[t.preset],t):t,this.element=O('<BUTTON class="spytext-button" st-button-type="'+t.preset+'" tabindex="-1">'),_.each(this.events,function(t,e){n.element.bind(e,t,n)}),this.disable()};e.prototype={setActive:function(){this.element.addClass("active")},unsetActive:function(){this.element.removeClass("active")},enable:function(){this.element.disabled=!1},disable:function(){this.element.disabled=!0,this.unsetActive()},events:{click:function(t){t.preventDefault(),this.spytext.execute(this.config.action,this.config.options)}},presets:{alignLeft:{title:"Align Left",action:"align",options:{alignment:"left"}},alignRight:{title:"Align Right",action:"align",options:{alignment:"right"}},alignCenter:{title:"Align Center",action:"align",options:{alignment:"center"}},alignJustify:{title:"Align Justify",action:"align",options:{alignment:"justify"}},bold:{title:"Bold",action:"format",options:{tag:"B"}},strikeThrough:{title:"Strike Through",action:"format",options:{tag:"STRIKE"}},underline:{title:"Underline",action:"format",options:{tag:"U"}},italic:{title:"Italic",action:"format",options:{tag:"I"}},removeFormat:{action:"removeFormat"},typeHeading1:{title:"Heading 1",action:"block",options:{tag:"H1"}},typeHeading2:{title:"Heading 2",action:"block",options:{tag:"H2"}},typeHeading3:{title:"Heading 3",action:"block",options:{tag:"H3"}},typeHeading4:{title:"Heading 4",action:"block",options:{tag:"H4"}},typeHeading5:{title:"Heading 5",action:"block",options:{tag:"H5"}},typeHeading6:{title:"Heading 6",action:"block",options:{tag:"H6"}},typeParagraph:{title:"Paragraph",action:"block",options:{tag:"P"}},orderedList:{title:"Ordered List",action:"list",options:{tag:"OL"}},unorderedList:{title:"Unordered List",action:"list",options:{tag:"UL"}},indent:{title:"Indent",action:"indent",options:{outdent:!1}},outdent:{title:"Outdent",action:"indent",options:{outdent:!0}}}};var n=function(t,e){var n=this;this.spytext=e,this.config="string"==typeof t.preset?_.merge(this.presets[t.preset],t):t,this.items=[],this.element=O('<ul class="spytext-dropdown">'),_.each(this.config.items,function(t){var e=O("<li><span>"+t.title+"</span></li>");n.element.append(e),_.each(n.events.item,function(t,i){e.bind(i,t,n)}),n.items.push(t)}),_.each(this.events.dropdown,function(t,e){n.element.bind(e,t,n)}),this.index=0,this.length=this.element.offspring().length,this.disable()};n.prototype={setIndex:function(t){this.index=t;for(var e=this.element.first().offsetHeight,n=this.element.offspring().toArray(),i=0;i<n.length;i++)n[i].css("top","-"+t*e+"px"),i===t?n[i].addClass("active"):n[i].removeClass("active")},setNoActive:function(){this.index=0;for(var t=this.element.offspring().toArray(),e=0;e<t.length;e++)t[e].css("top","0"),t[e].removeClass("active")},setActive:function(t){var e=(_.where(this.items,{options:t}),_.findIndex(this.items,function(e){for(var n in t)if(t[n]!==e.options[n])return!1;return!0}));this.setIndex(e)},enable:function(){this.element.removeClass("disabled")},disable:function(){this.element.addClass("disabled"),this.element.removeClass("expanded"),this.setNoActive()},events:{dropdown:{click:function(){this.spytext.field&&this.element.toggleClass("expanded")}},item:{click:function(t){if(this.element.hasClass("expanded")){var e=this.element.offspring().indexOf(t.currentTarget);this.spytext.execute(this.config.action,this.items[e].options)}}}},presets:{type:{action:"block",items:[{title:"Heading 1",options:{tag:"H1"}},{title:"Heading 2",options:{tag:"H2"}},{title:"Heading 3",options:{tag:"H3"}},{title:"Heading 4",options:{tag:"H4"}},{title:"Heading 5",options:{tag:"H5"}},{title:"Heading 6",options:{tag:"H6"}},{title:"Paragraph",options:{tag:"P"}}]}}};var i=function(t,e){var n=this;this.dropdowns=[],this.buttons=[],this.spytext=e,this.config="string"==typeof t.preset?_.merge(this.presets[t.preset],t):t,this.element=O('<DIV class="spytext-toolbar">'),_.each(this.config.dropdowns,this.addDropdown.bind(this)),_.each(this.config.buttonGroups,this.addButtonGroup.bind(this)),_.each(this.events,function(t,e){n.element.bind(e,t,n)})};i.prototype={addButtonGroup:function(t){var e=this,n=O("<UL>").addClass("spytext-button-group "+t.name);_.each(t.buttons,function(t){var i=O("<LI>"),s=e.addButton({preset:t},e.spytext);n.append(i),i.append(s.element)}),this.element.append(n)},addButton:function(t){var n=new e(t,this.spytext);return this.buttons[t.preset]=n,n},addDropdown:function(t){t="string"==typeof t?{preset:t}:t;var e=new n(t,this.spytext);return this.dropdowns[t.preset]=e,this.element.append(e.element),e},enable:function(){for(var t in this.buttons){var e=this.buttons[t];e.enable()}for(var n in this.dropdowns)this.dropdowns[n].enable()},disable:function(){for(var t in this.buttons)this.buttons[t].disable();for(var e in this.dropdowns)this.dropdowns[e].disable()},setActiveStyles:function(){function t(t){switch(t){case"P":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":n.dropdowns.type&&n.dropdowns.type.setActive({tag:t});break;case"UL":n.buttons.unorderedList.setActive(),n.dropdowns.type.setNoActive();break;case"OL":n.buttons.orderedList.setActive(),n.dropdowns.type.setNoActive()}}for(var e,n=this,i=[],s=[],a=0;!e;)if(e=this.spytext.selectron.range(),a++>1e4)return;if(e){if(e.collapsed)i=e.startContainer.ancestors(null,this.spytext.element).toArray(),i.length>0&&s.push(i.pop());else{var o=e.commonAncestorContainer;i=o.ancestors(null,this.spytext.element).toArray()}i=M(i);for(var r in this.buttons){var l=this.buttons[r];l.config.options&&i.includes(l.config.options.tag)?l.setActive():l.unsetActive()}for(var h,d=0;d<s.length;d++){if(h&&h!==s[d].tagName){h=null;break}h=s[d].tagName||null}h&&t(h)}},presets:{standard:{dropdowns:["type"],buttonGroups:[{name:"format",buttons:["bold","italic","underline","strikeThrough","removeFormat"]},{name:"align",buttons:["alignLeft","alignCenter","alignRight","alignJustify"]},{name:"list",buttons:["unorderedList","orderedList"]},{name:"indent",buttons:["indent","outdent"]}]},format:{buttonGroups:[{name:"format",buttons:["bold","underline","strikeThrough","removeFormat"]}]}},events:{mousedown:function(t){t.preventDefault()}}};var s=function(t,e,n){var i=this;this.spytext=t,this.element=e,this.element.attr("contentEditable","true"),this.config="string"==typeof n.preset?_.merge(this.presets[n],n):n,this.selectron=new Selectron(e),this.timeout=null,this.clearTextNodes(),this.snapback=new Snapback(e,{preset:"spytext",selectron:this.selectron}),_.each(this.events,function(t,n){e.bind(n,t,i)})};return s.prototype={clearTextNodes:function(){var t=this.element.childNodes.toArray();for(var e in t)3===t[e].nodeType&&(t[e].textContent.match(/^\s+$/)?t[e].vanish():(t[e].textContent=t[e].textContent.trim(),t[e].wrap(O("<p></p>"))));this.element.firstChild||this.element.append(O("<p><br /></p>")),this.element.setBR()},activate:function(){this.spytext.setCurrentField(this)},deactivate:function(){this.spytext.unsetCurrentField()},presets:{full:{buttons:["bold","italic","underline","strikeThrough","removeFormat"],dropdowns:["type "]},format:{buttons:["bold","italic","underline","strikeThrough","removeFormat"]}},events:{focus:function(){this.clearTextNodes(),this.snapback.enable(),this.activate()},blur:function(){this.snapback.register(),this.snapback.disable(),this.deactivate()},keyup:function(t){switch(t.keyCode){case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:this.spytext.toolbar.setActiveStyles()}},keydown:function(t){function e(e,n){var i=t.keyCode,s=Math.min(e,n),a=Math.max(e,n);return i>=s&&a>=i}var n=this;if(t.ctrlKey)switch(clearTimeout(this.timeout),this.timeout=null,this.snapback.register(),t.keyCode){case 66:case 85:t.preventDefault();var i=[];i[66]="bold",i[85]="underline",this.spytext.execute("format",{command:i[t.keyCode]},this.element);break;case 89:t.preventDefault(),this.snapback.redo();break;case 90:t.preventDefault(),this.snapback.undo();break;case 65:t.preventDefault(),this.selectron.select(this.element);break;case 84:t.preventDefault();break;case 86:}else{var s=this.selectron.range();e(33,40)?(clearTimeout(this.timeout),this.timeout=null,this.snapback.register()):!s.collapsed&&(8===t.keyCode||46===t.keyCode||13===t.keyCode||e(65,90)||e(48,57)||e(186,222)||e(96,111))?(this.snapback.register(),this.spytext.actions.deleteRangeContents.call(this.spytext,s),(8===t.keyCode||46===t.keyCode)&&t.preventDefault()):(clearTimeout(this.timeout),this.timeout=setTimeout(function(){n.timeout=null,n.snapback.register()},300));var a,o,r;switch(t.keyCode){case 8:if(s=this.selectron.range(),s.collapsed&&(o=this.element.childNodes.includes(s.startContainer)?s.startContainer:s.startContainer.closest(this.element.childNodes),o.matches("UL, OL")&&(a=1===s.startContainer.nodeType&&s.startContainer.matches("LI")?s.startContainer:s.startContainer.closest("LI")),r=this.selectron.get(a||o),0===r.start.offset)){t.preventDefault();var l=a&&a.previousSibling?a.previousSibling:o.previousSibling;l&&this.spytext.actions.join.call(this.spytext,l.matches("UL, OL")?l.lastChild:l,a?a:o)}break;case 46:if(s=this.selectron.range(),s.collapsed&&(o=this.element.childNodes.includes(s.startContainer)?s.startContainer:s.startContainer.closest(this.element.childNodes),o.matches("UL, OL")&&(a=1===s.startContainer.nodeType&&s.startContainer.matches("LI")?s.startContainer:s.startContainer.closest("LI")),r=this.selectron.get(a||o),r.start.offset===r.start.ref.textContent.length)){t.preventDefault();var h=a&&a.nextSibling?a.nextSibling:o.nextSibling;h&&this.spytext.actions.join.call(this.spytext,a?a:o,h.matches("UL, OL")?h.firstChild:h)}break;case 13:t.preventDefault(),this.spytext.actions.newline.call(this.spytext)}}},paste:function(t){t.preventDefault();var e=this;this.snapback.register();var n=this.selectron.range();n.collapsed||this.spytext.actions.deleteRangeContents.call(this.spytext,n),this.spytext.execute("paste",t.clipboardData?t.clipboardData:clipboardData),setTimeout(function(){e.snapback.register()},100)}}},t}();